name: Deploy Company Website

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 72.60.27.165
          username: dev
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            echo "Deploying Company Website..."
            cd /opt/stack/apps/company-website
            
            # Clone or update
            if [ ! -d "src/.git" ]; then
              git clone https://github.com/DataTranquil/comapny-website.git src
            else
              cd src && git pull origin main && cd ..
            fi
            
            # Create docker files if missing
            if [ ! -f "Dockerfile" ]; then
              cat > Dockerfile << 'EOF'
            FROM node:18-alpine
            WORKDIR /app
            COPY src/package*.json ./
            RUN npm ci
            COPY src/ .
            RUN npm run build
            EXPOSE 3000
            CMD ["npm", "start"]
            EOF
            fi
            
            if [ ! -f "docker-compose.yml" ]; then
              cat > docker-compose.yml << 'EOF'
            version: '3.8'
            services:
              company-website:
                build: .
                container_name: company-website
                restart: unless-stopped
                environment:
                  NODE_ENV: production
                networks:
                  - frontend
                labels:
                  - "traefik.enable=true"
                  - "traefik.docker.network=frontend"
                  - "traefik.http.routers.company.rule=Host(\`datatranquil.com\`) || Host(\`www.datatranquil.com\`)"
                  - "traefik.http.routers.company.entrypoints=websecure"
                  - "traefik.http.routers.company.tls.certresolver=le"
                  - "traefik.http.services.company.loadbalancer.server.port=3000"
            
            networks:
              frontend:
                external: true
            EOF
            fi
            
            # Build and deploy
            docker compose build
            docker compose up -d
            
            echo "Company Website deployed!"
